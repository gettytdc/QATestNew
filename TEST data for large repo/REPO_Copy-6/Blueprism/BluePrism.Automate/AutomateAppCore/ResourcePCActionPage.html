<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <title>Blue Prism Automate</title>
    <style type="text/css">
      body, textarea, input {
        font-family: arial, sans-serif;
        font-size: 8pt
      }
		body {margin-top:10px;background-color:#fff;text-align:center}
		#container {width:60%;margin:0 auto;padding-top:10px;background-color:#eef;}
		</style>

    <script type="text/javascript" language="javascript">

			// Sneak in support for standard XMLHttpRequest	creation in IE6...
			/*@cc_on @if (@_win32 && @_jscript_version >= 5) if (!window.XMLHttpRequest)
			window.XMLHttpRequest = function() { return new ActiveXObject('Microsoft.XMLHTTP') }
			@end @*/
	
	        // The following variables are pre-filled by Automate when the page is
	        // generated. They original come from parameters POSTed to Automate by the
	        // preceding page.
			var processname="$$AUTOMATE-process-$$"
			var username="$$AUTOMATE-user-$$"
			var password="$$AUTOMATE-password-$$"
			var params="$$AUTOMATE-params-$$"
			var desturl_err="$$AUTOMATE-desturl_err-$$"
			var desturl_ok="$$AUTOMATE-desturl_ok-$$"

			var txtMessages
			var http
            var showingdetails=false;
            var RunningSessionID="unknown"

			// Define some extra String functions...
			String.prototype.startsWith = function(s) { return this.indexOf(s)==0; }
			String.prototype.contains = function(s) { return this.indexOf(s) > -1; }

            function toggleDetails() {
                detailstext=document.getElementById("detailslink")
                detailsdiv=document.getElementById("details")
                if(showingdetails) {
                    detailsdiv.style.display="none"
                    detailstext.innerHTML="show details"
                    showingdetails=false
                }
                else {
                    detailsdiv.style.display="block"
                    detailstext.innerHTML="hide details"
                    showingdetails=true
                }
            }

            function handleError(message) {
                setStatusMsg(message,"#FF0000")
                log(message)
                if(desturl_err!="")
                    document.location=desturl_err
            }

            function setStatusMsg(message,col) {
                msg=document.getElementById("statusmsg")
                msg.innerHTML=message
                if(col!="")
                    msg.style.color=col
            }

			function log(message) {
				txtMessages.value+=GetTime()+":"+message+"\n"
			}

			function Load() {
				txtMessages = document.getElementById("txtMessages")
				txtMessages.value=""
				log("Ready")
				StartProcess()
			}


			function StartProcess() {

                setStatusMsg("Working, please wait...","")
				try {

					// Create our http object...
					http=new XMLHttpRequest()
					// Notify if we failed to create it...
					if(!http) {
						handleError("Failed to create http object")
						return
					}
					url="http://"+document.location.hostname+":$$AUTOMATE-port-$$/automateexec"
					postparams="cmd1=user%20name%20"+escape(username).replace("+","%2B")
					postparams+="&cmd2=password%20"+escape(password).replace("+","%2B")
					if(params.length>0) {
					    postparams+="&cmd2a=startp%20"+escape(params).replace("+","%2B")
					}
					postparams+="&cmd3=create%20name%20"+escape(processname).replace("+","%2B")
					postparams+="&cmd4=start%20last"
					http.open("POST", url, true)
					http.onreadystatechange=StartProcess2
					log("Sending request")
                    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
                    http.setRequestHeader("Content-length", postparams.length)
					http.send(postparams)
				}
				catch(e) {
					handleError("Failed: "+e.name+":"+e.message)
				}
			}

			function StartProcess2() {
				if(http.readyState==4) {
					if(http.status==200) {
						response=http.responseText.split(/\r\n|\r|\n/);
						if(!response[0].startsWith("USER SET")) {
							handleError("Failed to set user - "+response[0])
							return
						}
						if(!response[1].startsWith("USER AUTHENTICATED")) {
							handleError("Failed to authenticate - "+response[1])
							return
						}
						i=2
						if(params.length>0) {
						    if(!response[i].startsWith("PARAMETERS SET")) {
						        handleError("Failed to set startup parameters - "+response[i])
						        return
                            }
                            i++
						}
						if(!response[i].startsWith("SESSION CREATED")) {
							handleError("Did not create session - "+response[i])
							return
						}
						RunningSessionID=response[i].substring(18)
						log("Session ID:"+RunningSessionID)
						if(!response[i+1].startsWith("STARTED")) {
							handleError("Did not start - "+response[i+1])
							return
						}
                        setStatusMsg("Running, please wait...","")
						log("SUCCESS - Process started")
						setTimeout("CheckStatus()", 1000)
					} else {
						handleError("Request failed:"+http.status)
					}
				}
			}

            function CheckStatus() {
                if(http.readyState==4) {
                    http.open("GET","http://"+document.location.hostname+":$$AUTOMATE-port-$$/status",true);
				    http.onreadystatechange=GotStatus
				    http.send(null)
				}
			}
			
			function GotStatus() {
                if(http.readyState==4) {
        		    if(http.status==200) {
			            response=http.responseText.split(/\r\n|\r|\n/);
		                for(i=0;i<response.length;i++) {
			                if(response[i].match(RunningSessionID)) {
				                curstatus=response[i].split(" ")[2];
				                log("Status:"+curstatus)
				                if(curstatus=="RUNNING") {
				                    setTimeout("CheckStatus()", 500);
				                }
				                else {
				                    setStatusMsg("Process "+curstatus,curstatus=="COMPLETED"?"#009900":"#CC0000")
				                    if(curstatus=="COMPLETED") {
                                        if(desturl_ok!="")
                                            document.location=desturl_ok
                                    } else {
                                        if(desturl_err!="")
                                            document.location=desturl_err
                                    }
				                }
			                }
		                }
		            }
		            else {
		                handleError("Failed to get status - HTTP error "+http.status)
        		    }
        		}
			}

			function GetTime() {

				var dDate = new Date
				var sDate = dDate.toString()
				var iColon = sDate.indexOf(":")
				return sDate.substr(iColon-2,8)

			}
    </script>

</head>
<body onload="Load()">
    <div id="container">
        <h1>Blue Prism Automate</h1>
        <p id="statusmsg">Loading, please wait...</p>
        <a href="#" onclick="toggleDetails();return false"><span id="detailslink">show details</span></a>
        <br />
        <br />
        <div id="details" style="display:none">
            <textarea rows="15" cols="80" id="txtMessages" style="width: 400px; height: 150px"></textarea>
            <br/>
        </div>
    </div>
</body>
</html>
