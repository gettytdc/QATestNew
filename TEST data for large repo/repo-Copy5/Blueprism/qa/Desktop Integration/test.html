<html>  
	<head>
		<style>	
		body, textarea, input {font-family:arial; font-size:8pt}
		</style>

		<script type="text/javascript" src="test.js"></script>
		<script language="javascript">

			// Sneak in support for standard XMLHttpRequest	creation in IE6...
			/*@cc_on @if (@_win32 && @_jscript_version >= 5) if (!window.XMLHttpRequest)
			window.XMLHttpRequest = function() { return new ActiveXObject('Microsoft.XMLHTTP') }
			@end @*/
	
			var btnStart
			var txtMessages
			var msStatus = ""
			var http
			var sessionid
			var SessionCreators
			
			// Define a String.startsWith function...
			String.prototype.startsWith = function(s) { return this.indexOf(s)==0; }
			
			//Define a String.contains function
			String.prototype.contains = function(s) { return this.indexOf(s) > -1; }
			
				

			function log(message) {
				txtMessages.value+=GetTime()+":"+message+"\n"
			}

			function Load() {
				btnStart = document.getElementById("btnStart")
				txtMessages = document.getElementById("txtMessages")
				txtMessages.value=""
				
				// Create our http object...
				try
				{
					http=new XMLHttpRequest()
				}
				catch(err)
				{
					log("Error - could not create xmlhttprequest object")
				}
				
				
				// Notify if we failed to create it...
				if (!http) {
					log("Failed to create http object")
					return
				}
				
				http.open("GET", "http://localhost:8181/proclist", true)
				http.onreadystatechange=PopulateProcessList
				log("Getting list of processes")
				http.send(null)
				
			}

			
			function CreateSessions() {
				//Get name of selected process in list
				var lstProcesses=document.getElementById("lstProcesses")
				if (lstProcesses.selectedIndex == -1) {
					alert("Please first select a process from the list")
					return
				}
				
				if (!SessionCreators) {
					SessionCreators = new Array();
				}
				for (var i=0; i<lstProcesses.length;i++) {
					if (lstProcesses.options[i].selected) {
						SessionCreators.push(new SessionCreator("admin", lstProcesses.options[i].text));
					}
				}
				
				try {
					for (var i=0;i<SessionCreators.length;i++) {
						SessionCreators[i].createSession();
					}
					checkStatusOfSessions();
				}
				catch(ex) {
					alert("Failed to start process - " + ex);
				}
			}
			
			function checkStatusOfSessions() {
				var ProcessStillRunning
				for (var i=0;i<SessionCreators.length;i++) {
					var SC = SessionCreators[i];
					var Status 
					try {
						Status = SC.checkSessionStatus();
					}
					 catch(ex) {
					 //do nothing
					 alert(ex);
					}
					if (Status) {
						var SessionPanel = document.getElementById(SC.getSessionID());
						if (!SessionPanel) {
							SessionPanel = createStatusPanelForSession(SC.getSessionID());
						}
						SessionPanel.firstChild.nodeValue = SC.getProcessName() + " - " + Status;
						
						if (Status=="RUNNING")
							ProcessStillRunning = "true";
					}
				}
				
				if (ProcessStillRunning) {
					self.setTimeout("checkStatusOfSessions()", 500);
				}
				else {
					self.clearTimeout();
				}
			}

 			function createStatusPanelForSession(SessionID) {
				var StatusArea = document.getElementById("StatusArea");
				var Panel = document.createElement("div");
				Panel.setAttribute("id", SessionID);
				Panel.appendChild(document.createTextNode("DEFAULT"));
				StatusArea.appendChild(Panel);
				return Panel
 			}
			

			function PopulateProcessList() {
				var lstProcesses=document.getElementById("lstProcesses")
				if(http.readyState==4) {
					if (http.status==200) {
						response=http.responseText.split(/\r\n|\r|\n/);
						for(var i=0; i<=response.length -1;i++)
						{
							var columns=columns=response[i].split(" - ") //format of the response is "guid - name"
							var choice = document.createElement('option');
							choice.value=columns[0] //process ID
							choice.appendChild(document.createTextNode(columns[1])); //process name
							lstProcesses.appendChild(choice);
						}
						log("Done getting processes")
					} else {
						log("Population of processes failed:"+http.status)
					}
				}
			}
			
			
			
			

			function GetTime() {

				var dDate = new Date
				var sDate = dDate.toString()
				var iColon = sDate.indexOf(":")
				return sDate.substr(iColon-2,8)

			}
		</script>


	</head>	

  <body onload="Load()">	 
    Process<br/><SELECT id="lstProcesses" multiple="multiple" style="width:300px" size="10"></SELECT><br/>
    <div id="StatusArea" style="width:300px; height:200px; background:lightgrey; float:right; border:2px;" ></div>
    
		<BR>
    <INPUT type=button id="btnStart" style="width:100px" value="Start" onClick="CreateSessions()">
    <BR>
		Javascript Messages
		<br>
		<TEXTAREA id="txtMessages" style="width:400px; height:150px"></TEXTAREA> 
  </body>
</html>
